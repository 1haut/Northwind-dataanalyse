<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">

    <title>Northwind Mini Dashboard</title>
    <meta content="" name="description">
    <meta content="" name="keywords">


    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Manrope:wght@200..800&family=Montserrat:ital,wght@0,100..900;1,100..900&family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&family=Work+Sans:ital,wght@0,100..900;1,100..900&display=swap"
        rel="stylesheet">

    <!-- Bootstrap Files -->
    <link href="https://cdn.datatables.net/v/bs5/dt-2.1.8/b-3.1.2/rr-1.5.0/datatables.min.css" rel="stylesheet">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <!-- Template Main CSS File -->
    <link href="style.css" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- =======================================================
  * Template Name: NiceAdmin
  * Template URL: https://bootstrapmade.com/nice-admin-bootstrap-admin-html-template/
  * Updated: Apr 20 2024 with Bootstrap v5.3.3
  * Author: BootstrapMade.com
  * License: https://bootstrapmade.com/license/
  ======================================================== -->
</head>

<body>
    <main id="main" class="main">

        <div class="pagetitle text-center py-4">
            <h1>Northwind Dashboard</h1>
        </div><!-- End Page Title -->

        <section class="section dashboard">
            <div class="row">
                <div class="col-12">
                    <div class="row row-container">

                        <!-- Sales Card -->
                        <div class="col-lg-4 col-sm-6">
                            <div class="card info-card sales-card">

                                <div class="card-body">
                                    <h5 class="card-title">Orders <span>| YTD</span></h5>

                                    <div class="d-flex align-items-center">
                                        <div class="ps-3">
                                            <h6 class="card-value">.</h6>

                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div><!-- End Sales Card -->

                        <!-- Revenue Card -->
                        <div class="col-lg-4 col-sm-6">
                            <div class="card info-card revenue-card">

                                <div class="card-body">
                                    <h5 class="card-title">Revenue <span>| YTD</span></h5>

                                    <div class="d-flex align-items-center">
                                        <div class="ps-3">
                                            <h6 class="card-value">.</h6>

                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div><!-- End Revenue Card -->

                        <!-- Customers Card -->
                        <div class="col-lg-4 col-sm-12">

                            <div class="card info-card customers-card">
                                <div class="card-body">
                                    <h5 class="card-title">Customers <span>| YTD</span></h5>

                                    <div class="d-flex align-items-center">
                                        <div class="ps-3">
                                            <h6 class="card-value">1244</h6>
                                        </div>
                                    </div>

                                </div>
                            </div>

                        </div><!-- End Customers Card -->

                        <!-- Reports -->
                        <div class="col-12">
                            <div class="card charts-container">

                                <div class="card-body">
                                    <h5 class="card-title">Reports <span>| All time</span></h5>
                                    <div class="row report-charts">

                                        <div class="col-lg-6">
                                            <div class="card">
                                                <div class="card-body">
                                                    <h5 class="card-title">Number of Sales per Month</h5>

                                                    <!-- Line Chart -->
                                                    <canvas id="lineChart" class="chart-canvas"></canvas>


                                                    <!-- End Line CHart -->

                                                </div>
                                            </div>
                                        </div>

                                        <div class="col-lg-6">
                                            <div class="card">
                                                <div class="card-body">
                                                    <h5 class="card-title">Sales by Employee</h5>

                                                    <!-- Bar Chart -->
                                                    <canvas id="barChart" class="chart-canvas"></canvas>

                                                    <!-- End Bar Chart -->

                                                </div>
                                            </div>
                                        </div>

                                        <div class="col-lg-6">
                                            <div class="card pie-chart">
                                                <div class="card-body">
                                                    <h5 class="card-title">Sales by Category</h5>
                                                    <button type="button" class="btn btn-sm btn-danger popover-btn"
                                                        data-bs-toggle="popover" data-bs-title="Infomation on usage"
                                                        data-bs-content="Filter out different categories by clicking on the category label."
                                                        data-bs-trigger="hover">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                                                            fill="currentColor" class="bi bi-info-square-fill"
                                                            viewBox="0 0 16 16">
                                                            <path
                                                                d="M0 2a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2zm8.93 4.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533zM8 5.5a1 1 0 1 0 0-2 1 1 0 0 0 0 2" />
                                                        </svg>
                                                    </button>

                                                    <!-- Pie Chart -->
                                                    <canvas id="pieChart" class="chart-canvas"></canvas>

                                                    <!-- End Pie CHart -->

                                                </div>
                                            </div>
                                        </div>

                                        <div class="col-lg-6">
                                            <div class="card">
                                                <div class="card-body">
                                                    <h5 class="card-title">Combined Sales and Storage</h5>

                                                    <!--Combined Chart-->
                                                    <canvas id="comboBarLine" class="chart-canvas"></canvas>

                                                </div>
                                            </div>
                                        </div>

                                    </div>

                                </div>

                            </div>
                        </div><!-- End Reports -->

                        <!-- Database Table -->
                        <div class="col-12">
                            <div class="card recent-sales overflow-auto">

                                <div class="card-body">
                                    <div class="over-table">
                                        <h5 class="card-title">Database Table</h5>
                                        <button type="button" class="btn btn-info new-btn" data-bs-toggle="modal"
                                            data-bs-target="#exampleModal">New</button>
                                    </div>

                                    <div class="row">
                                        <div class="col-lg-3 col-md-6">
                                            <select class="form-select" id="table-picker"
                                                aria-label="Default select example">
                                                <option value="" selected>Pick a table to display</option>
                                                <option value="employees">Employees</option>
                                                <option value="products">Products</option>
                                                <option value="customers">Customers</option>
                                                <option value="orders">Orders</option>
                                            </select>
                                        </div>
                                    </div>


                                    <table id="example" class="table table-striped table-hover" style="width:100%">
                                    </table>
                                </div>
                            </div>
                        </div>
                        <!-- End Database Table-->
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- ======= Footer ======= -->
    <footer id="footer" class="footer">
        <div class="copyright">
            &copy; Copyright <strong><span>NiceAdmin</span></strong>. All Rights Reserved
        </div>
        <div class="credits">
            <!-- All the links in the footer should remain intact. -->
            <!-- You can delete the links only if you purchased the pro version. -->
            <!-- Licensing information: https://bootstrapmade.com/license/ -->
            <!-- Purchase the pro version with working PHP/AJAX contact form: https://bootstrapmade.com/nice-admin-bootstrap-admin-html-template/ -->
            Designed by <a href="https://bootstrapmade.com/">BootstrapMade</a>
        </div>
    </footer><!-- End Footer -->
    <!-- Modal -->
    <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="exampleModalLabel">Add new <span class="tabl">employee</span></h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form class="modal-form">
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="saveChangesBtn" data-bs-dismiss="modal">Save
                        changes</button>
                </div>
            </div>
        </div>
    </div>
    <!-- jQuery (required for Bootstrap) -->
    <script src="https://code.jquery.com/jquery-3.7.1.js"></script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script src="https://cdn.datatables.net/v/bs5/dt-2.1.8/b-3.1.2/rr-1.5.0/datatables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="index.js"></script>
    <script>
        //  Render Line Chart
        async function renderLineChart() {
            const response = await fetch('/api/line-chart');
            const data = await response.json();
            const labels = data.map(item => item.month);
            const salesData = data.map(item => item.sales_count);

            let gradientFill = document.getElementById('lineChart').getContext("2d")
                .createLinearGradient(0, 250, 0, 32);
            gradientFill.addColorStop(1, 'rgb(173, 216, 230)');
            gradientFill.addColorStop(0, 'rgb(255,255,255)');

            let myChart = new Chart(document.querySelector('#lineChart'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Monthly Sales',
                        data: salesData,
                        borderColor: 'rgb(173, 216, 230)',
                        fill: {
                            target: 'origin',
                            above: gradientFill
                        },
                        tension: 0.1
                    }]
                },
                options: {
                    animation: {
                        easing: "easeInOutExpo"
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Render Bar Chart
        async function renderBarChart() {
            const response = await fetch('/api/bar-chart');
            const data = await response.json();
            const labels = data.map(item => item.full_name);
            const orderData = data.map(item => item.number_of_sales);


            let myChart = new Chart(document.querySelector('#barChart'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '# of Orders',
                        data: orderData,
                        backgroundColor: 'rgba(54, 162, 235, 0.5)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: { scales: { y: { beginAtZero: true } } }
            });
        }

        // Render Pie Chart
        async function renderPieChart() {
            const response = await fetch('/api/pie-chart');
            const data = await response.json();
            const labels = data.map(item => item.category_name);
            const productData = data.map(item => item.sales_per_category);

            let myChart = new Chart(document.querySelector('#pieChart'), {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: productData,
                        backgroundColor: [
                            'rgb(244, 122, 31)',
                            'rgb(253, 187, 47)',
                            'rgb(55, 123, 43)',
                            'rgb(122, 193, 66)',
                            'rgb(0, 124, 195)',
                            'rgb(0, 82, 155)',
                            'rgb(138, 43, 226)',
                            'rgb(227, 38, 54)'
                        ]
                    }]
                }
            });
        }

        // Render Combo Chart
        async function renderComboChart() {
            const response = await fetch('/api/combo-chart');
            const data = await response.json();

            const newLabels = data.map(item => item.product_name);
            const lineData = data.map(item => item.product_sales);
            const barData = data.map(item => item.units_in_stock);

            const combinedChart = new Chart(document.querySelector('#comboBarLine'), {
                type: 'bar',
                data: {
                    labels: newLabels,
                    datasets: [
                        {
                            label: 'Units (Bar)',
                            data: barData,
                            backgroundColor: 'rgba(54, 162, 235, 0.5)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1,
                            type: 'bar'
                        },
                        {
                            label: 'Sales (Line)',
                            data: lineData,
                            backgroundColor: 'rgba(255, 99, 132, 0.5)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 2,
                            type: 'line',
                            fill: false
                        }
                    ]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Render Orders
        function renderOrders() {
            $.getJSON('/api/orders-num', function (ordersCount) {
                $('.card-value').text(ordersCount);
            });
        }

        // Render Revenue
        function renderRevenue() {
            $.getJSON('/api/revenue', function (revenueUSD) {
                $('.revenue-card .card-value').text('$ ' + revenueUSD);
            });
        }

        // Render Customers
        function renderCustomers() {
            $.getJSON('/api/customers', function (customers) {
                $('.customers-card .card-value').text(customers);
            });
        }

        function dataTable1() {
            const $tableForm = $('#table-picker')
            let displayTable = $('#table-picker :selected').val() // Default table shown

            console.log(displayTable)

            $tableForm.on('change', function () {
                if (displayTable !== "") {
                }
                displayTable = $('#table-picker :selected').val()
                console.log(displayTable)
                $.ajax({
                    url: `/${displayTable}`,
                    method: 'GET',
                    success: function (data) {
                        if (data.length > 0) {
                            const columns = Object.keys(data[0]).map(key => ({
                                title: key.charAt(0).toUpperCase() + key.slice(1),
                                data: key
                            }));


                            // Action buttons (Edit/Delete)
                            if (displayTable !== 'orders' && columns[columns.length - 1].title !== 'Actions') {
                                columns.push({
                                    title: 'Actions',
                                    data: null,
                                    defaultContent: `
                  <button class="btn btn-sm btn-warning edit-btn">Edit</button>
                  <button class="btn btn-sm btn-danger delete-btn">Delete</button>
                `,
                                    orderable: false
                                });
                            }

                            // Initialize DataTable
                            $('#example').DataTable({
                                data: data,
                                columns: columns
                            });

                            const allData = $('#example').DataTable().rows().data()
                            const firstRow = $('#example').DataTable().row().data()
                            const titleCase = (s) =>
                                s.replace(/^_*(.)|_+(.)/g, (s, c, d) => c ? c.toUpperCase() : ' ' + d.toUpperCase())

                            // Populate form data
                            const $form = $('.modal-form');
                            if ($form.children().length < 1) {
                                const $container = $('<div>', { class: 'mb-3' }).appendTo($form);
                                for (let i = 0; i < Object.keys(firstRow).length; i++) {
                                    const column = Object.keys(firstRow)[i]
                                    $container.append(`<label for="${column}" class="form-label">${titleCase(column)} </label>`);
                                    $container.append(`<input type="text" class="form-control" id="${column}" name="${column}" placeholder="${titleCase(column)}">`);
                                }
                            }

                            // Handle Delete button click
                            $('#example tbody').on('click', '.delete-btn', function () {
                                const rowData = $('#example').DataTable().row($(this).parents('tr')).data();
                                let rowId

                                if (displayTable === 'customers') {
                                    for (let i = 0; i < allData.length; i++) {
                                        if (allData[i].customer_id == rowData.customer_id) {
                                            console.log(i + 1, rowData.customer_id, displayTable)
                                            rowId = i + 1
                                        }
                                    }
                                }

                                if (confirm('Are you sure you want to delete this record?')) {
                                    $.ajax({
                                        url: `/${displayTable}/${rowData.order_id || rowData.product_id || rowData.employee_id || rowId}`,
                                        method: 'DELETE',
                                        success: function (response) {
                                            alert('Record deleted successfully.');
                                            location.reload()
                                        },
                                        error: function (xhr, status, error) {
                                            console.error('Error deleting record:', error);
                                            alert('Failed to delete the record. Please try again.');
                                        }
                                    });
                                }
                            });


                            // Handle Edit button click
                            $('#example tbody').on('click', '.edit-btn', function () {
                                const rowData = $('#example').DataTable().row($(this).parents('tr')).data();
                                $form.attr('method', '')
                                for (let i = 0; i < Object.keys(rowData).length; i++) {
                                    const objKey = Object.keys(rowData)[i]
                                    const objVal = Object.values(rowData)[i]
                                    $(`.modal-body #${objKey}`).val(objVal)
                                }
                                $('#exampleModal').modal('show');
                                console.log('Edit clicked for:', rowData);
                            })

                            // Handle New button click
                            $('.new-btn').on('click', function () {
                                $form.attr('method', 'post')
                                for (let i = 0; i < Object.keys(firstRow).length; i++) {
                                    const objKey = Object.keys(firstRow)[i]
                                    $(`.modal-body #${objKey}`).val('')
                                }
                            })
                        } else {
                            console.warn('No data available to populate the table.');
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error('Failed to fetch data:', error);
                    }
                });
            })
        }

        function postClick() {
            $(document).ready(function () {
                $('#saveChangesBtn').on('click', function () {
                    const displayTable = $('#table-picker :selected').val()
                    const allData = $('#example').DataTable().rows().data()
                    let rowId
                    // Collect form data
                    const formData = {};
                    $('.modal-form input').each(function () {
                        formData[$(this).attr('name')] = $(this).val();
                    });



                    if (displayTable === 'customers') {
                        for (let i = 0; i < allData.length; i++) {
                            if (allData[i].customer_id == formData.customer_id) {
                                console.log(i + 1, formData.customer_id, displayTable)
                                rowId = i
                            }
                        }
                    }

                    const method = $('.modal-form').attr('method') === 'post' ? 'POST' : 'PATCH';
                    const url = method === 'POST' ? `/${displayTable}` : `/${displayTable}/${formData.order_id || formData.product_id || formData.employee_id || rowId}`;
                    console.log(method, url, formData)

                    // Send HTTP request
                    $.ajax({
                        url: url,
                        method: method,
                        contentType: 'application/json',
                        data: JSON.stringify(formData),
                        success: function (response) {
                            alert('Success.');
                            location.reload()
                        },
                        error: function (xhr, status, error) {
                            console.error('Error saving changes:', error);
                            alert('Failed to save changes. Please try again.');
                        }
                    });
                });
            });
        }

        function initPopover() {
            const popoverTriggerList = document.querySelectorAll('[data-bs-toggle="popover"]');
            const popoverList = [...popoverTriggerList].map(popoverTriggerEl => new bootstrap.Popover(popoverTriggerEl));
        }

        // Call the functions
        document.addEventListener("DOMContentLoaded", () => {
            renderLineChart();
            renderBarChart();
            renderPieChart();
            renderComboChart();
            renderOrders();
            renderRevenue();
            renderCustomers();
            dataTable1();
            postClick();
            initPopover();
        });
    </script>
</body>

</html>